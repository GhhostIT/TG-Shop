from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, InputFile
from aiogram.utils import executor
import asyncio

TOKEN = 'YOUR_BOT_TOKEN'

bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# Товары по категориям
categories = {
    "VPN": ["NordVPN - 5$", "SurfsharkVPN - 3$"],
    "Гайды": ["Заработок в телеграм - 10$", "Арбитраж трафика - 15$"],
    "Расходники": ["Логи США - 2$", "Логи РФ - 1$"]
}

# Корзина для пользователей
user_carts = {}

# Главное меню
def main_menu():
    keyboard = InlineKeyboardMarkup(row_width=1)
    keyboard.add(
        InlineKeyboardButton("Shop", callback_data="shop"),
        InlineKeyboardButton("TG Channel", url="https://t.me/+oYfxuzp0MERkNjg6")
    )
    return keyboard

# Кнопка домой
def home_button():
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("Home", callback_data="home"))
    return keyboard

# Вывод категорий
def categories_menu():
    keyboard = InlineKeyboardMarkup(row_width=1)
    for category in categories.keys():
        keyboard.add(InlineKeyboardButton(category, callback_data=f"category_{category}"))
    keyboard.add(InlineKeyboardButton("Home", callback_data="home"))
    return keyboard

# Товары внутри категории
def products_menu(category_name):
    keyboard = InlineKeyboardMarkup(row_width=1)
    for product in categories.get(category_name, []):
        keyboard.add(InlineKeyboardButton(product, callback_data=f"add_{product}"))
    keyboard.add(InlineKeyboardButton("Корзина", callback_data="cart"))
    keyboard.add(InlineKeyboardButton("Home", callback_data="home"))
    return keyboard

# Корзина
def cart_menu():
    keyboard = InlineKeyboardMarkup(row_width=1)
    keyboard.add(
        InlineKeyboardButton("Оформить заказ", callback_data="checkout"),
        InlineKeyboardButton("Очистить корзину", callback_data="clear_cart"),
        InlineKeyboardButton("Home", callback_data="home")
    )
    return keyboard

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    photo = InputFile('logo.png')  # сюда вставляешь название файла с логотипом
    await message.answer_photo(photo=photo, caption="**Premium Work Shop**", parse_mode="Markdown", reply_markup=main_menu())

@dp.callback_query_handler(lambda c: True)
async def process_callback(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id

    if callback_query.data == "home":
        await bot.edit_message_caption(
            chat_id=callback_query.message.chat.id,
            message_id=callback_query.message.message_id,
            caption="**Premium Work Shop**",
            parse_mode="Markdown",
            reply_markup=main_menu()
        )

    elif callback_query.data == "shop":
        await bot.edit_message_caption(
            chat_id=callback_query.message.chat.id,
            message_id=callback_query.message.message_id,
            caption="Выберите категорию:",
            parse_mode="Markdown",
            reply_markup=categories_menu()
        )

    elif callback_query.data.startswith("category_"):
        category = callback_query.data.split("_")[1]
        await bot.edit_message_caption(
            chat_id=callback_query.message.chat.id,
            message_id=callback_query.message.message_id,
            caption=f"Товары в категории {category}:",
            parse_mode="Markdown",
            reply_markup=products_menu(category)
        )

    elif callback_query.data.startswith("add_"):
        product = callback_query.data.split("_", 1)[1]
        if user_id not in user_carts:
            user_carts[user_id] = []
        user_carts[user_id].append(product)
        await bot.answer_callback_query(callback_query.id, text=f"Добавлено в корзину: {product}")

    elif callback_query.data == "cart":
        cart = user_carts.get(user_id, [])
        if not cart:
            await bot.answer_callback_query(callback_query.id, text="Корзина пуста!")
        else:
            cart_text = "\n".join(cart)
            await bot.edit_message_caption(
                chat_id=callback_query.message.chat.id,
                message_id=callback_query.message.message_id,
                caption=f"Ваша корзина:\n\n{cart_text}",
                parse_mode="Markdown",
                reply_markup=cart_menu()
            )

    elif callback_query.data == "clear_cart":
        user_carts[user_id] = []
        await bot.answer_callback_query(callback_query.id, text="Корзина очищена.")

    elif callback_query.data == "checkout":
        cart = user_carts.get(user_id, [])
        if not cart:
            await bot.answer_callback_query(callback_query.id, text="Корзина пуста!")
            return
        total = sum([int(item.split("-")[-1].replace("$", "").strip()) for item in cart])
        await bot.send_message(user_id, f"Ваш заказ на сумму {total}$.\nПереходите к оплате через CryptoBot.")
        user_carts[user_id] = []  # очищаем корзину после отправки чека

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)

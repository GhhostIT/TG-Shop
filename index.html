<!-- исправленный sendOrder -->
<script>
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
  Telegram.WebApp.ready();
}

const categories = [
  { id: 'vpn', title: 'ВПН' },
  { id: 'manuals', title: 'Мануалы' },
  { id: 'supplies', title: 'Расходники' }
];

const products = {
  vpn: [
    { id: 1, name: "VPN Pro", price: 2, description: "Лучший VPN", image: "" },
    { id: 2, name: "VPN Ultra", price: 3, description: "Ультра скорость", image: "" },
    { id: 3, name: "VPN Basic", price: 1, description: "Базовый VPN", image: "" },
    { id: 4, name: "VPN Max", price: 5, description: "Максимальная защита", image: "" }
  ],
  manuals: [
    { id: 5, name: "Гайд №1", price: 1, description: "Полный гайд", image: "" },
    { id: 6, name: "Гайд №2", price: 2, description: "Пошаговый гайд", image: "" },
    { id: 7, name: "Гайд №3", price: 2, description: "Экспертный гайд", image: "" },
    { id: 8, name: "Гайд №4", price: 3, description: "Бонусный гайд", image: "" }
  ],
  supplies: [
    { id: 9, name: "Расходник 1", price: 1, description: "Расходный материал 1", image: "" },
    { id: 10, name: "Расходник 2", price: 2, description: "Расходный материал 2", image: "" },
    { id: 11, name: "Расходник 3", price: 2, description: "Расходный материал 3", image: "" },
    { id: 12, name: "Расходник 4", price: 3, description: "Расходный материал 4", image: "" }
  ]
};

const cart = [];

function goHome() {
  document.getElementById('startScreen').style.display = 'flex';
  document.getElementById('categories').style.display = 'none';
  document.getElementById('products').style.display = 'none';
  document.getElementById('cart').style.display = 'none';
}

function goToShop() {
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('categories').style.display = 'block';
  document.getElementById('products').style.display = 'none';
  document.getElementById('cart').style.display = 'block';
  renderCategories();
}

function goToChannel() {
  window.open('https://t.me/+oYfxuzp0MERkNjg6', '_blank');
}

function renderCategories() {
  const categoriesDiv = document.getElementById('categories');
  categoriesDiv.innerHTML = '';
  categories.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'category';
    div.innerHTML = `<div class="category-title">${cat.title}</div>`;
    div.onclick = () => showProducts(cat.id);
    categoriesDiv.appendChild(div);
  });
}

function showProducts(categoryId) {
  document.getElementById('categories').style.display = 'none';
  const productsDiv = document.getElementById('products');
  productsDiv.innerHTML = `<button class="button" onclick="backToCategories()">Назад</button>`;
  products[categoryId].forEach(prod => {
    const div = document.createElement('div');
    div.className = 'product';
    div.innerHTML = `
      <div class="product-image">Заглушка</div>
      <div class="product-title">${prod.name}</div>
      <p>${prod.description}</p>
      <p>Цена: ${prod.price} $</p>
      <div class="counter">
        <button onclick="changeQuantity(${prod.id}, -1)">-</button>
        <span id="count-${prod.id}">0</span>
        <button onclick="changeQuantity(${prod.id}, 1)">+</button>
      </div>
    `;
    productsDiv.appendChild(div);
  });
  productsDiv.style.display = 'block';
}

function backToCategories() {
  document.getElementById('products').style.display = 'none';
  document.getElementById('categories').style.display = 'block';
}

function changeQuantity(productId, delta) {
  const product = Object.values(products).flat().find(p => p.id === productId);
  const item = cart.find(i => i.id === productId);
  if (item) {
    item.quantity += delta;
    if (item.quantity <= 0) {
      const index = cart.indexOf(item);
      cart.splice(index, 1);
    }
  } else if (delta > 0) {
    cart.push({ ...product, quantity: 1 });
  }
  const countElement = document.getElementById(`count-${productId}`);
  if (countElement) {
    countElement.innerText = cart.find(i => i.id === productId)?.quantity || 0;
  }
  renderCart();
}

function renderCart() {
  const cartUl = document.getElementById('cartItems');
  cartUl.innerHTML = '';
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.quantity;
    const li = document.createElement('li');
    li.innerHTML = `
      ${item.name} x ${item.quantity}
      <button onclick="changeQuantity(${item.id}, -1)">-</button>
    `;
    cartUl.appendChild(li);
  });
  document.getElementById('cartTotal').innerText = `Итого: ${total} $`;
}

function sendOrder() {
  const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  const simplifiedCart = cart.map(item => ({
    id: item.id,
    name: item.name,
    quantity: item.quantity,
    price: item.price
  }));
  const order = {
    cart: simplifiedCart,
    total
  };

  if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    Telegram.WebApp.sendData(JSON.stringify(order));
  } else {
    alert('Ошибка отправки заказа через Telegram');
    console.log('Order data:', order);
  }
}
</script>
